<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control Financiero Multi-Empresa</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de la fuente Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Estilos personalizados y tipografía */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Color de fondo claro (Slate-50) */
        }
        .scrollable {
            max-height: 500px; /* Altura máxima para la lista de transacciones */
            overflow-y: auto;
        }
        /* Estilos para la barra de desplazamiento */
        .scrollable::-webkit-scrollbar {
            width: 8px;
        }
        .scrollable::-webkit-scrollbar-thumb {
            background-color: #94a3b8; /* Slate-400 */
            border-radius: 4px;
        }
        /* Clases de utilidad para colores de estado */
        .ingreso-bg { background-color: #d1fae5; } /* Green-100 */
        .gasto-bg { background-color: #fee2e2; } /* Red-100 */

        /* Estilos de tabla responsiva */
        @media (max-width: 768px) {
            .table-row {
                display: flex;
                flex-wrap: wrap;
                margin-bottom: 1rem;
                padding: 1rem;
                border: 1px solid #e2e8f0; /* Slate-200 */
                border-radius: 0.5rem;
            }
            .table-cell {
                flex: 1 1 100%; /* Las celdas ocupan el 100% en móvil */
                padding: 0.25rem 0;
            }
            .table-cell:before {
                content: attr(data-label);
                font-weight: 600;
                margin-right: 0.5rem;
                display: inline-block;
                width: 100px; /* Anchura de la etiqueta para alineación */
            }
            .table-header {
                display: none; /* Ocultar encabezados en móvil */
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-900">
                Panel Financiero
            </h1>
            <div class="flex space-x-4">
                <button onclick="window.switchView('finances')" id="finances-btn" class="px-4 py-2 rounded-lg text-sm font-medium transition duration-150 bg-blue-600 text-white hover:bg-blue-700">
                    Finanzas
                </button>
                <button onclick="window.switchView('converter')" id="converter-btn" class="px-4 py-2 rounded-lg text-sm font-medium transition duration-150 text-gray-700 hover:bg-gray-100">
                    Convertidor
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Contenedor Principal de la Aplicación -->
        <div id="app-container">
            <!-- Vista de Finanzas (Activa por defecto) -->
            <div id="finances-view" class="space-y-6">

                <!-- Selector de Compañía y Balance General -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 border-b pb-4">
                        <div class="mb-4 md:mb-0">
                            <label for="company-select" class="block text-sm font-medium text-gray-700 mb-2">
                                Compañía Activa:
                            </label>
                            <select id="company-select" onchange="window.switchCompany(this.value)" class="mt-1 block w-full md:w-64 pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                                <option value="LEOON TEAM">LEOON TEAM</option>
                                <option value="SUBLY">SUBLY</option>
                            </select>
                        </div>

                        <div id="balance-container" class="text-right">
                            <p class="text-sm font-medium text-gray-500">Balance Total (USD)</p>
                            <p id="current-balance" class="text-4xl font-extrabold text-gray-900 mt-1">$0.00</p>
                        </div>
                    </div>
                </div>

                <!-- Formulario para Nueva Transacción -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Registrar Nueva Transacción</h2>
                    <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <!-- Tipo -->
                        <div class="md:col-span-2">
                            <label for="type" class="block text-sm font-medium text-gray-700">Tipo</label>
                            <select id="type" name="type" required class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                <option value="ingreso">Ingreso</option>
                                <option value="gasto">Gasto</option>
                            </select>
                        </div>
                        <!-- Monto -->
                        <div class="md:col-span-2">
                            <label for="amount" class="block text-sm font-medium text-gray-700">Monto (USD)</label>
                            <input type="number" id="amount" name="amount" step="0.01" required placeholder="0.00" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <!-- Fecha -->
                        <div class="md:col-span-2">
                            <label for="date" class="block text-sm font-medium text-gray-700">Fecha</label>
                            <input type="date" id="date" name="date" required value="" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <!-- Descripción -->
                        <div class="md:col-span-6">
                            <label for="description" class="block text-sm font-medium text-gray-700">Descripción</label>
                            <input type="text" id="description" name="description" required placeholder="Ej: Pago de cliente, Compra de material" class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <!-- Botón de Envío -->
                        <div class="md:col-span-6 flex justify-end">
                            <button type="submit" class="w-full md:w-auto inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                                Registrar Transacción
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Utilidades de Datos: Exportar / Importar / Guardar -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Utilidades de Datos</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <!-- Botón Exportar a CSV (Guardar como) -->
                        <button onclick="window.exportToCSV()" class="flex items-center justify-center space-x-2 py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-500 hover:bg-green-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path d="M11.25 10.5v6m-3-3h6m3-8.675C17.472 2.378 16.275 1.5 15 1.5h-2.25V6L8.25 1.5H7.5A1.5 1.5 0 0 0 6 3v2.25L1.5 9v10.5a1.5 1.5 0 0 0 1.5 1.5h18a1.5 1.5 0 0 0 1.5-1.5V9l-4.5-4.5h-2.25Zm-8.497 2.47a.75.75 0 0 1-.722.53h-.022A.75.75 0 0 1 5.25 8.25V7.5h.75a.75.75 0 0 1 0 1.5H5.25a.75.75 0 0 1-.723-.53l-.022-.054a.75.75 0 0 1 .55-1.026.75.75 0 0 1 .722.53Z" />
                            </svg>
                            <span>Exportar a CSV</span>
                        </button>
                        
                        <!-- Botón Guardar Copia Local (Forzar Guardado) -->
                        <button onclick="window.saveTransactionsLocalManual()" class="flex items-center justify-center space-x-2 py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-500 hover:bg-indigo-600 transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M12 2.25a.75.75 0 0 1 .75.75v11.66l2.97-2.97a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0l-4.25-4.25a.75.75 0 1 1 1.06-1.06l2.97 2.97V3a.75.75 0 0 1 .75-.75Zm-5.25 17.25a.75.75 0 0 1 0 1.5h10.5a.75.75 0 0 1 0-1.5H6.75Z" clip-rule="evenodd" />
                            </svg>
                            <span>Guardar Copia Local</span>
                        </button>

                        <!-- Importar Datos (Guardar como / Cargar) -->
                        <div class="relative">
                             <!-- CAMBIADO: Aceptar solo archivos CSV -->
                             <input type="file" id="import-file" accept=".csv" class="hidden" onchange="window.handleImport(event)">
                             <button onclick="document.getElementById('import-file').click()" class="w-full flex items-center justify-center space-x-2 py-3 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-yellow-500 hover:bg-yellow-600 transition duration-150">
                                 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 16.17a7.5 7.5 0 0 1 14.998 0 .75.75 0 0 1-.433.82c-.859.39-1.782.724-2.753.999a48.57 48.57 0 0 1-9.034 0c-.971-.275-1.894-.609-2.753-.999a.75.75 0 0 1-.432-.82Zm6.452 3.012l.235.526a1.5 1.5 0 0 0 1.341.972l.189.006A1.5 1.5 0 0 0 14.184 19.7z" clip-rule="evenodd" />
                                 </svg>
                                 <!-- CAMBIADO: Etiqueta a CSV -->
                                 <span>Importar/Cargar (.csv)</span>
                             </button>
                        </div>
                    </div>
                </div>

                <!-- Listado de Transacciones -->
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Historial de Transacciones</h2>
                    <div id="transactions-list-container" class="scrollable border border-gray-200 rounded-lg">
                        <div class="table-header hidden md:grid grid-cols-6 gap-4 p-4 bg-gray-50 text-xs font-semibold uppercase text-gray-600 border-b">
                            <div class="col-span-1">Tipo</div>
                            <div class="col-span-2">Descripción</div>
                            <div class="col-span-1 text-right">Monto (USD)</div>
                            <div class="col-span-1 text-right">Fecha</div>
                            <div class="col-span-1 text-center">Acciones</div>
                        </div>
                        <div id="transactions-list" class="divide-y divide-gray-200">
                            <!-- Las transacciones se renderizarán aquí -->
                        </div>
                    </div>
                    <div id="empty-state" class="text-center py-8 text-gray-500 hidden">
                        Aún no hay transacciones registradas para esta compañía. Los datos se guardan localmente en tu navegador.
                    </div>
                </div>
            </div>

            <!-- Vista de Convertidor de Moneda (Oculta por defecto) -->
            <div id="converter-view" class="space-y-6 hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">Conversor de Moneda (USD a COP)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Entrada de Monto -->
                        <div>
                            <label for="usd-amount" class="block text-sm font-medium text-gray-700">Monto en USD ($)</label>
                            <input type="number" id="usd-amount" step="0.01" value="1.00" required class="mt-1 block w-full py-2 px-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <!-- Tasa y Botón -->
                        <div class="flex flex-col justify-end">
                            <button id="convert-btn" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
                                Convertir
                            </button>
                        </div>
                    </div>
                    <!-- Resultado -->
                    <div id="conversion-result" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200 text-center">
                        <p class="text-xl font-bold text-blue-800">Resultado: <span>$0.00 COP</span></p>
                        <p class="text-xs text-blue-600 mt-1">
                            La tasa de conversión USD/COP actual es: <span id="conversion-rate" class="font-semibold">Cargando...</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal de Mensajes/Error -->
        <div id="app-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center p-4 transition-opacity duration-300 z-50" aria-modal="true" role="dialog">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm transform transition-all">
                <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-4">Título</h3>
                <p id="modal-body" class="text-sm text-gray-600 mb-6">Cuerpo del mensaje.</p>
                <div class="flex justify-end">
                    <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition duration-150">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>

    </main>

    <!-- Lógica de la Aplicación -->
    <script>
        // --- Variables Globales ---
        let transactionsStore = []; // Caché en memoria de las transacciones de la compañía actual
        let currentCompany = 'LEOON TEAM';
        let currentExchangeRate = null; // Tasa de cambio USD/COP

        // Definición de las columnas esperadas en el CSV
        const EXPECTED_CSV_HEADERS = ["Tipo", "Monto (USD)", "Fecha", "Descripción"];
        // La columna de ID no se espera en el archivo importado, se genera al importar.

        // Función para generar un ID único
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Función para mostrar un modal (reemplaza alert/confirm)
        function showModal(title, body) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-body').textContent = body;
            document.getElementById('app-modal').classList.remove('hidden');
        }

        /**
         * Obtiene la clave de localStorage para la compañía actual.
         * @returns {string} Clave de localStorage.
         */
        function getLocalStorageKey(company) {
            return `app-finance-transactions-${company.toUpperCase().replace(/\s/g, '_')}`;
        }

        /**
         * Guarda el array 'transactionsStore' en localStorage.
         */
        function saveTransactions() {
            try {
                const key = getLocalStorageKey(currentCompany);
                localStorage.setItem(key, JSON.stringify(transactionsStore));
                // console.log(`Transacciones guardadas para ${currentCompany} en localStorage.`);
                return true;
            } catch (e) {
                console.error("Error al guardar en localStorage:", e);
                showModal("Error de Guardado Local", "No se pudieron guardar los datos. El almacenamiento local puede estar lleno.");
                return false;
            }
        }
        
        /**
         * Función para forzar el guardado manual (Guardar)
         */
        window.saveTransactionsLocalManual = function() {
            if (saveTransactions()) {
                showModal("Guardado Exitoso", `Las transacciones de ${currentCompany} se han guardado localmente en tu navegador.`);
            }
        }

        /**
         * Carga las transacciones de localStorage para la compañía actual.
         */
        function loadTransactions() {
            const key = getLocalStorageKey(currentCompany);
            const storedData = localStorage.getItem(key);
            transactionsStore = storedData ? JSON.parse(storedData) : [];
            console.log(`Transacciones cargadas para ${currentCompany}. Total: ${transactionsStore.length}`);
            renderTransactions(transactionsStore);
        }

        /**
         * Renderiza una lista de transacciones en la interfaz de usuario.
         * @param {Array<Object>} transactions - El array de transacciones.
         */
        function renderTransactions(transactions) {
            const listElement = document.getElementById('transactions-list');
            const emptyState = document.getElementById('empty-state');
            listElement.innerHTML = ''; // Limpiar lista

            if (transactions.length === 0) {
                listElement.classList.add('hidden');
                emptyState.classList.remove('hidden');
                updateBalance(0); // Balance a cero si no hay transacciones
                return;
            }

            listElement.classList.remove('hidden');
            emptyState.classList.add('hidden');

            let totalBalance = 0;

            // Ordenar por fecha y luego por timestamp (más reciente primero, orden descendente)
            const sortedTransactions = transactions.sort((a, b) => {
                // Asegurar que la fecha sea manejable
                const dateA = new Date(a.date).getTime();
                const dateB = new Date(b.date).getTime();

                // Primero ordenar por fecha (más reciente primero)
                if (dateB !== dateA) {
                    return dateB - dateA;
                }
                // Si la fecha es igual, ordenar por el timestamp de creación (más reciente primero)
                return b.timestamp - a.timestamp;
            });

            sortedTransactions.forEach(t => {
                const amount = parseFloat(t.amount);
                const typeClass = t.type === 'ingreso' ? 'ingreso-bg text-green-700' : 'gasto-bg text-red-700';
                const sign = t.type === 'ingreso' ? '+' : '-';
                // Usar el formato YYYY-MM-DD guardado para el objeto Date
                const formattedDate = new Date(t.date + 'T00:00:00').toLocaleDateString('es-ES');

                totalBalance += t.type === 'ingreso' ? amount : -amount;

                const row = document.createElement('div');
                row.className = `table-row grid md:grid-cols-6 gap-4 p-4 hover:bg-gray-50 transition duration-100 ${typeClass}`;
                row.dataset.id = t.id; // Almacenar el ID del documento

                row.innerHTML = `
                    <div class="table-cell col-span-1 font-semibold capitalize" data-label="Tipo:">${t.type}</div>
                    <div class="table-cell col-span-2 text-gray-800" data-label="Descripción:">${t.description}</div>
                    <div class="table-cell col-span-1 text-right font-mono" data-label="Monto:">
                        <span class="font-bold">${sign}$${Math.abs(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}</span>
                    </div>
                    <div class="table-cell col-span-1 text-right text-gray-600 text-sm" data-label="Fecha:">${formattedDate}</div>
                    <div class="table-cell col-span-1 flex justify-center space-x-2" data-label="Acciones:">
                        <button onclick="window.handleDeleteTransaction('${t.id}')" class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-white" aria-label="Eliminar transacción">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M16.5 4.478a.75.75 0 0 1 .428.204l4.5 4.5a.75.75 0 0 1 .204.428V19.5a2.25 2.25 0 0 1-2.25 2.25h-13.5A2.25 2.25 0 0 1 3 19.5V9.61a.75.75 0 0 1 .204-.428l4.5-4.5a.75.75 0 0 1 .428-.204h7.5Zm-9.927.427a1.5 1.5 0 0 1 2.121 0l4.5 4.5a1.5 1.5 0 0 1 0 2.121l-4.5 4.5a1.5 1.5 0 0 1-2.121 0l-4.5-4.5a1.5 1.5 0 0 1 0-2.121l4.5-4.5Z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                `;
                listElement.appendChild(row);
            });

            updateBalance(totalBalance);
        }

        /**
         * Actualiza el saldo total en la interfaz.
         * @param {number} balance - El saldo total.
         */
        function updateBalance(balance) {
            const balanceElement = document.getElementById('current-balance');
            const colorClass = balance >= 0 ? 'text-green-600' : 'text-red-600';

            // Limpiar clases de color anteriores y aplicar la nueva
            balanceElement.className = balanceElement.className.replace(/text-(green|red)-600/g, '') + ` ${colorClass}`;

            balanceElement.textContent = `$${balance.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}`;
        }

        /**
         * Manejador para agregar una nueva transacción.
         */
        async function handleAddTransaction(event) {
            event.preventDefault();

            const form = event.target;
            const type = form.type.value;
            const amount = parseFloat(form.amount.value);
            const dateStr = form.date.value; // Formato YYYY-MM-DD
            const description = form.description.value.trim();

            if (isNaN(amount) || amount <= 0 || description === '') {
                showModal("Error de Validación", "Por favor, introduce un monto positivo y una descripción válida.");
                return;
            }

            // Crear el objeto de la transacción con ID y timestamp local
            const newTransaction = {
                id: generateUUID(),
                type: type,
                amount: amount,
                date: new Date(dateStr + 'T00:00:00').toISOString().split('T')[0], // Guardar solo la fecha en formato ISO (YYYY-MM-DD)
                description: description,
                timestamp: Date.now(), // Timestamp de creación para ordenamiento secundario
                company: currentCompany,
            };

            transactionsStore.push(newTransaction);
            saveTransactions(); // Guardar en localStorage
            loadTransactions(); // Recargar y renderizar la interfaz

            form.reset(); // Limpiar el formulario
            document.getElementById('date').valueAsDate = new Date(); // Resetear fecha al día de hoy
            showModal("Transacción Registrada", `El ${type} de $${amount.toFixed(2)} se ha añadido correctamente a ${currentCompany}.`);
        }

        /**
         * Manejador para eliminar una transacción por su ID.
         */
        window.handleDeleteTransaction = function(transactionId) {
            if (!transactionId) return;

            const initialLength = transactionsStore.length;
            // Filtrar el array para remover la transacción
            transactionsStore = transactionsStore.filter(t => t.id !== transactionId);

            if (transactionsStore.length < initialLength) {
                saveTransactions(); // Guardar el nuevo estado
                loadTransactions(); // Recargar y renderizar la interfaz
                showModal("Transacción Eliminada", "El registro financiero ha sido borrado exitosamente.");
            } else {
                showModal("Error al Eliminar", "No se encontró la transacción para eliminar.");
            }
        }

        /**
         * Exporta las transacciones actuales a un archivo CSV.
         */
        window.exportToCSV = function() {
            if (transactionsStore.length === 0) {
                showModal("Exportación Fallida", "No hay transacciones para exportar.");
                return;
            }

            // Usamos las mismas cabeceras que se esperan en la importación, más las internas
            const header = ["ID", "Compañía", "Tipo", "Monto (USD)", "Fecha", "Descripción"];
            const csvRows = [];
            csvRows.push(header.join(';')); // Separador de punto y coma para compatibilidad

            transactionsStore.forEach(t => {
                const amount = (t.type === 'gasto' ? '-' : '') + parseFloat(t.amount).toFixed(2);
                const row = [
                    `"${t.id}"`, // ID entre comillas
                    `"${t.company}"`,
                    `"${t.type}"`,
                    amount.replace('.', ','), // Reemplazar punto por coma para formato de número
                    `"${t.date}"`, // Fecha YYYY-MM-DD
                    `"${t.description.replace(/"/g, '""')}"` // Sanitizar descripción
                ];
                csvRows.push(row.join(';'));
            });

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const filename = `Transacciones_${currentCompany}_${new Date().toISOString().split('T')[0]}.csv`;

            // Crear un enlace temporal para la descarga
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showModal("Exportación Completa", `Las transacciones de ${currentCompany} se han exportado como ${filename}.`);
        }
        
        /**
         * CONVERSIÓN DE CSV A TRANSACCIONES
         */
        window.handleImport = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const importedTransactions = parseCSV(csvText);

                    // Reemplazar la tienda actual (comportamiento de 'Guardar como' o 'Cargar')
                    transactionsStore = importedTransactions; 
                    saveTransactions();
                    loadTransactions();
                    
                    showModal("Importación Exitosa", `${importedTransactions.length} transacciones han sido importadas y cargadas en ${currentCompany}.`);

                } catch (error) {
                    console.error("Error al importar el archivo CSV:", error);
                    showModal("Error de Importación", `Error al procesar el archivo CSV: ${error.message}. Asegúrate de que las cabeceras y el formato sean correctos (Tipo;Monto (USD);Fecha;Descripción).`);
                }
                // Resetear el input file para permitir cargar el mismo archivo de nuevo
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        /**
         * Parsea una cadena CSV y devuelve un array de objetos de transacción.
         * Espera el formato: Tipo;Monto (USD);Fecha;Descripción
         * @param {string} csvText - Contenido del archivo CSV.
         * @returns {Array<Object>} Array de transacciones válidas.
         */
        function parseCSV(csvText) {
            // Dividir en filas (manejar diferentes saltos de línea)
            const rows = csvText.trim().split(/[\r\n]+/);
            if (rows.length < 2) {
                throw new Error("El archivo CSV está vacío o solo contiene la cabecera.");
            }
            
            // Determinar el delimitador: buscar el que aparece más en la primera fila (encabezados)
            const firstRow = rows[0];
            let delimiter = ','; // Coma por defecto
            // Intentar detectar un delimitador común si el primero no es una coma
            if (firstRow.split(';').length > firstRow.split(',').length) {
                delimiter = ';'; // Punto y coma si es más común
            } else if (firstRow.split('\t').length > firstRow.split(',').length) {
                 delimiter = '\t'; // Tabulador
            }
            
            // 1. Obtener cabeceras y mapearlas a índices
            const headers = rows[0].split(delimiter).map(h => h.trim().replace(/"/g, ''));
            
            // Mapeo para facilitar el acceso por nombre de columna
            // CAMBIO: Hacemos el mapeo más tolerante para evitar errores con nombres de columna ligeramente diferentes.
            const headerMap = {
                // Tipo: busca cualquier columna que contenga 'tipo'
                'tipo': headers.findIndex(h => h.toLowerCase().includes('tipo')),
                // Monto: busca cualquier columna que contenga 'monto' o 'valor' (más flexible que Monto (USD))
                'monto': headers.findIndex(h => h.toLowerCase().includes('monto') || h.toLowerCase().includes('valor')),
                // Fecha: busca cualquier columna que contenga 'fecha'
                'fecha': headers.findIndex(h => h.toLowerCase().includes('fecha')),
                // Descripción: busca cualquier columna que contenga 'descrip'
                'descripcion': headers.findIndex(h => h.toLowerCase().includes('descrip')),
            };
            
            // 2. Validación de Cabeceras
            // Usamos las claves de mapeo más flexibles
            if (headerMap.tipo === -1 || headerMap.monto === -1 || headerMap.fecha === -1 || headerMap.descripcion === -1) {
                throw new Error(`Cabeceras CSV inválidas. Se esperan al menos: ${EXPECTED_CSV_HEADERS.join(', ')}. Verifica que las columnas estén presentes y sean legibles.`);
            }

            const newTransactions = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].trim();
                if (!row) continue;

                // Simple split por el delimitador detectado
                const values = row.split(delimiter).map(v => v.trim().replace(/"/g, ''));
                
                // Asegurar que haya suficientes columnas
                if (values.length < headers.length) {
                    // Si faltan columnas, podría ser una línea mal formada, la ignoramos
                    console.warn(`Fila ${i + 1} incompleta:`, row);
                    continue; 
                }

                try {
                    // Extracción y saneamiento de valores
                    let type = values[headerMap.tipo].toLowerCase().trim();
                    let amountStr = values[headerMap.monto].trim(); // CAMBIO: Usamos la clave 'monto'
                    let dateStr = values[headerMap.fecha].trim();
                    let description = values[headerMap.descripcion].trim();
                    
                    // Manejar formato de número: aceptar '.' o ',' como separador decimal
                    amountStr = amountStr.replace('.', '#').replace(',', '.').replace('#', '');
                    let amount = parseFloat(amountStr.replace(/[^\d.-]/g, '')); // Eliminar cualquier caracter no numérico (excepto . y -)

                    // Si el monto es negativo, forzar el tipo a 'gasto'
                    if (amount < 0) {
                        type = 'gasto';
                        amount = Math.abs(amount);
                    }
                    
                    // Validación de tipo
                    if (type !== 'ingreso' && type !== 'gasto') {
                        // Si el tipo no es claro, lo intentamos inferir del monto o lo forzamos a 'gasto' por seguridad
                        type = amount >= 0 ? 'ingreso' : 'gasto'; 
                        amount = Math.abs(amount);
                    }

                    if (isNaN(amount) || amount <= 0) {
                        throw new Error(`Monto inválido: ${values[headerMap.monto]}`);
                    }
                    if (description === '') {
                        description = 'Transacción importada sin descripción';
                    }
                    // Sanitizar y forzar la fecha al formato YYYY-MM-DD
                    const date = new Date(dateStr);
                    if (isNaN(date.getTime())) {
                       // Si la fecha es inválida, usar la fecha de hoy
                       dateStr = new Date().toISOString().split('T')[0];
                    } else {
                        // Formatear la fecha a YYYY-MM-DD para almacenamiento consistente
                        dateStr = date.toISOString().split('T')[0];
                    }


                    const newTransaction = {
                        id: generateUUID(),
                        type: type,
                        amount: amount,
                        date: dateStr, 
                        description: description,
                        timestamp: Date.now() + i, // Asegurar un timestamp único
                        company: currentCompany,
                    };

                    newTransactions.push(newTransaction);

                } catch (e) {
                    console.error(`Error de procesamiento en la fila ${i + 1}: ${e.message}`, values);
                    // No lanzar error aquí, solo en el nivel superior.
                }
            }
            
            if (newTransactions.length === 0) {
                 throw new Error("No se pudieron extraer transacciones válidas del archivo CSV. Revisa el formato.");
            }

            return newTransactions;
        }

        /**
         * Cambia la vista activa (Finanzas o Convertidor).
         * @param {string} viewName - 'finances' o 'converter'.
         */
        window.switchView = function(viewName) {
            const financesView = document.getElementById('finances-view');
            const converterView = document.getElementById('converter-view');
            const financesBtn = document.getElementById('finances-btn');
            const converterBtn = document.getElementById('converter-btn');

            // Lógica para cambiar la visibilidad de las vistas
            if (viewName === 'finances') {
                financesView.classList.remove('hidden');
                converterView.classList.add('hidden');
                // Lógica de estilo para botones
                financesBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                financesBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                converterBtn.classList.remove('bg-green-600', 'text-white', 'hover:bg-green-700');
                converterBtn.classList.add('text-gray-700', 'hover:bg-gray-100');
            } else if (viewName === 'converter') {
                financesView.classList.add('hidden');
                converterView.classList.remove('hidden');
                // Lógica de estilo para botones
                converterBtn.classList.add('bg-green-600', 'text-white', 'hover:bg-green-700');
                converterBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                financesBtn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                financesBtn.classList.add('text-gray-700', 'hover:bg-gray-100');
            }
        }

        /**
         * Cambia la compañía activa y recarga las transacciones de localStorage.
         * @param {string} companyName - Nombre de la nueva compañía.
         */
        window.switchCompany = function(companyName) {
            if (currentCompany !== companyName) {
                currentCompany = companyName;
                document.getElementById('company-select').value = companyName;
                console.log(`Cambiando a compañía: ${currentCompany}`);

                // Cargar datos del almacenamiento local para la nueva compañía
                loadTransactions();
            }
        }

        /**
         * Llama a la API de Google Search para obtener la tasa de cambio USD a COP.
         * Implementa reintentos con backoff exponencial.
         */
        async function fetchExchangeRate() {
            const rateElement = document.getElementById('conversion-rate');
            rateElement.textContent = 'Buscando tasa...';

            // Definición de la consulta
            const userQuery = "Tasa de cambio USD a COP actual";
            const apiKey = "" // El API Key se inyecta automáticamente en Canvas

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "Extrae únicamente el valor numérico de la tasa de cambio USD a COP del texto de la búsqueda. Por ejemplo, si el texto es '1 USD = 3850 COP', devuelve '3850'. Si no hay un número claro, devuelve 'ERROR'." }]
                },
            };

            const maxRetries = 3;
            let currentRetry = 0;

            while (currentRetry < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const rateText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

                    if (rateText && rateText !== 'ERROR') {
                        const rate = parseFloat(rateText);
                        if (!isNaN(rate) && rate > 0) {
                            currentExchangeRate = rate;
                            rateElement.textContent = currentExchangeRate.toFixed(4);
                            console.log(`Tasa de cambio USD/COP obtenida: ${currentExchangeRate}`);
                            return; // Salir del bucle y la función al tener éxito
                        }
                    }
                    // Si la IA no devolvió un valor numérico válido
                    console.warn(`Intento ${currentRetry + 1} fallido: La IA no devolvió una tasa válida. Respuesta: ${rateText}`);

                } catch (error) {
                    console.error(`Error en la llamada a la API (Intento ${currentRetry + 1}):`, error);
                }

                currentRetry++;
                if (currentRetry < maxRetries) {
                    // Esperar con backoff exponencial
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, currentRetry) * 1000));
                }
            }

            // Si falla después de todos los reintentos
            rateElement.textContent = 'No disponible';
            currentExchangeRate = null;
            showModal("Error de Conversión", "No se pudo obtener la tasa de cambio actual. La funcionalidad de conversión estará limitada.");
        }

        /**
         * Manejador para la conversión de moneda.
         */
        function handleConvertCurrency() {
            const usdInput = document.getElementById('usd-amount');
            const resultSpan = document.querySelector('#conversion-result span');
            const usdAmount = parseFloat(usdInput.value);

            if (isNaN(usdAmount) || usdAmount <= 0) {
                showModal("Monto Inválido", "Por favor, introduce un monto en USD válido y positivo para convertir.");
                return;
            }

            if (!currentExchangeRate) {
                showModal("Tasa No Disponible", "La tasa de cambio actual no se ha cargado. Por favor, espera o inténtalo de nuevo.");
                return;
            }

            const copAmount = usdAmount * currentExchangeRate;
            resultSpan.textContent = `$${copAmount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} COP`;
        }

        // --- INICIO DE LA APLICACIÓN ---

        window.onload = async () => {
            // Establecer la fecha actual por defecto en el formulario
            document.getElementById('date').valueAsDate = new Date();

            // Cargar la tasa de cambio al iniciar
            await fetchExchangeRate();

            // Cargar las transacciones iniciales (desde localStorage)
            loadTransactions();

            // Asignar manejador de evento al formulario
            const form = document.getElementById('transaction-form');
            if(form) form.addEventListener('submit', handleAddTransaction);

            // Asignar manejador de evento al conversor
            const convertBtn = document.getElementById('convert-btn');
            if(convertBtn) convertBtn.addEventListener('click', handleConvertCurrency);

            // Configurar la vista inicial (Finanzas) y la compañía por defecto (LEOON TEAM)
            window.switchView('finances');
            window.switchCompany('LEOON TEAM');
        };
    </script>
</body>
</html>
